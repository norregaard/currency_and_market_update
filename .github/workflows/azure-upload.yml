name: Daily Azure Blob Upload

on:
  schedule:
    - cron: '0 8 10 * *'  # 8:00 AM UTC = 10:00 AM CEST (July 2025, DST)
  workflow_dispatch:  # Allows manual triggering

permissions:
  id-token: write  # Required for OIDC
  contents: read   # Required to checkout repository

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Paris  # Ensures CET/CEST compatibility
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests yfinance python-dotenv
      - name: Generate report
        env:
          METAL_API_KEY: ${{ secrets.METAL_API_KEY }}
          BLOB_STORAGE_BASE_URL: ${{ secrets.BLOB_STORAGE_BASE_URL }}
        run: python scripts/generate_report.py
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          auth-type: IDENTITY
      - name: Upload to Azure Blob Storage
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            az storage blob upload-batch \
              --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }} \
              --destination $web \
              --source dist/ \
              --overwrite